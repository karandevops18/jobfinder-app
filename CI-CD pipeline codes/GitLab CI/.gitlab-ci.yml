# .gitlab-ci.yml
stages:
  - build
  - deploy

# Required: Run docker-in-docker for building images
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # Image tag used for immutable deploy
  IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"

# Use docker:dind service to allow docker build & push
build_and_push:
  stage: build
  image: docker:24.0.2
  services:
    - name: docker:24-dind
      alias: docker
  before_script:
    - apk add --no-cache bash curl jq git python3 py3-pip
    - pip3 install --no-cache-dir awscli
    - aws --version
    - export AWS_REGION="${AWS_REGION}"
    - echo "Logging into ECR..."
    - aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
  script:
    - echo "Building frontend image..."
    - docker build -t jobfinder-frontend:local ./frontend
    - echo "Building backend image..."
    - docker build -t jobfinder-backend:local ./backend
    - echo "Tagging images for ECR..."
    - FE_REPO="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_FE_REPO}"
    - BE_REPO="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_BE_REPO}"
    - docker tag jobfinder-frontend:local ${FE_REPO}:latest
    - docker tag jobfinder-frontend:local ${FE_REPO}:${IMAGE_TAG}
    - docker tag jobfinder-backend:local ${BE_REPO}:latest
    - docker tag jobfinder-backend:local ${BE_REPO}:${IMAGE_TAG}
    - echo "Pushing frontend images..."
    - docker push ${FE_REPO}:latest
    - docker push ${FE_REPO}:${IMAGE_TAG}
    - echo "Pushing backend images..."
    - docker push ${BE_REPO}:latest
    - docker push ${BE_REPO}:${IMAGE_TAG}
  artifacts:
    expire_in: 1h
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always

deploy_to_ecs:
  stage: deploy
  image: alpine:3.18
  before_script:
    - apk add --no-cache bash curl jq python3 py3-pip
    - pip3 install --no-cache-dir awscli
    - aws --version
    - export AWS_REGION="${AWS_REGION}"
  script:
    - set -e
    - echo "Preparing variables..."
    - FE_IMAGE="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_FE_REPO}:${IMAGE_TAG}"
    - BE_IMAGE="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_BE_REPO}:${IMAGE_TAG}"
    - echo "Frontend image to deploy: $FE_IMAGE"
    - echo "Backend  image to deploy: $BE_IMAGE"
    #
    # Frontend: fetch current taskdef, replace image for container 'frontend', register new taskdef, update service
    #
    - echo "Deploying frontend..."
    - TASK_ARN_FE=$(aws ecs describe-services --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE_FRONTEND" --region "$AWS_REGION" --query 'services[0].taskDefinition' --output text)
    - aws ecs describe-task-definition --task-definition "$TASK_ARN_FE" > taskdef-fe.json
    - jq --arg img "$FE_IMAGE" '.taskDefinition.containerDefinitions |= map(if .name == "frontend" then .image = $img else . end)' taskdef-fe.json > taskdef-fe-new.json
    - jq '.taskDefinition |= { family: .family, networkMode: .networkMode, cpu: .cpu, memory: .memory, executionRoleArn: .executionRoleArn, taskRoleArn: .taskRoleArn, requiresCompatibilities: .requiresCompatibilities, containerDefinitions: .containerDefinitions } | .taskDefinition' taskdef-fe-new.json > fe-register.json
    - NEW_FE_ARN=$(aws ecs register-task-definition --cli-input-json file://fe-register.json --query 'taskDefinition.taskDefinitionArn' --output text)
    - aws ecs update-service --cluster "$ECS_CLUSTER" --service "$ECS_SERVICE_FRONTEND" --task-definition "$NEW_FE_ARN" --force-new-deployment --region "$AWS_REGION"
    #
    # Backend: same process
    #
    - echo "Deploying backend..."
    - TASK_ARN_BE=$(aws ecs describe-services --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE_BACKEND" --region "$AWS_REGION" --query 'services[0].taskDefinition' --output text)
    - aws ecs describe-task-definition --task-definition "$TASK_ARN_BE" > taskdef-be.json
    - jq --arg img "$BE_IMAGE" '.taskDefinition.containerDefinitions |= map(if .name == "backend" then .image = $img else . end)' taskdef-be.json > taskdef-be-new.json
    - jq '.taskDefinition |= { family: .family, networkMode: .networkMode, cpu: .cpu, memory: .memory, executionRoleArn: .executionRoleArn, taskRoleArn: .taskRoleArn, requiresCompatibilities: .requiresCompatibilities, containerDefinitions: .containerDefinitions } | .taskDefinition' taskdef-be-new.json > be-register.json
    - NEW_BE_ARN=$(aws ecs register-task-definition --cli-input-json file://be-register.json --query 'taskDefinition.taskDefinitionArn' --output text)
    - aws ecs update-service --cluster "$ECS_CLUSTER" --service "$ECS_SERVICE_BACKEND" --task-definition "$NEW_BE_ARN" --force-new-deployment --region "$AWS_REGION"
    #
    # Wait for services stable (poll)
    #
    - echo "Waiting for services to stabilize..."
    - aws ecs wait services-stable --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE_FRONTEND" "$ECS_SERVICE_BACKEND" --region "$AWS_REGION"
    - echo "Deployment complete. Frontend: $FE_IMAGE Backend: $BE_IMAGE"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
